

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>python_tamer.ExposureMap &mdash; python-TAMER 0.4.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> python-TAMER
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Introduction to python-TAMER</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_reference.html">Code Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licence.html">Licence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">python-TAMER</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>python_tamer.ExposureMap</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for python_tamer.ExposureMap</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">numpy.core.numeric</span> <span class="kn">import</span> <span class="n">True_</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeat</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span> <span class="nn">matplotlib.projections</span> <span class="kn">import</span> <span class="n">get_projection_class</span>
<span class="kn">from</span> <span class="nn">cartopy.io</span> <span class="kn">import</span> <span class="n">shapereader</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp2d</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">zoom</span>
<span class="kn">from</span> <span class="nn">.subroutines</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="ExposureMap"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMap">[docs]</a><span class="k">class</span> <span class="nc">ExposureMap</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; A class for calculating maps based on user specifications</span>

<span class="sd">    Each instance of this class contains information required to calculate and illustrate a map</span>
<span class="sd">    of exposure information, be that simple averages or more advanced mathematical representations</span>
<span class="sd">    of exposure risk. The class is designed to have three core functions run in sequence, with</span>
<span class="sd">    room for flexibility should more advanced users desire it. First, the data is read and a pixel</span>
<span class="sd">    histogram is calculated. This allows much more data to be stored in memory and is the basis</span>
<span class="sd">    for performing this kind of data analysis on personal computers.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    units : str</span>
<span class="sd">        The units of the quantity to be mapped. Must be &quot;SED&quot;, &quot;J m-2&quot; or &quot;UVIh&quot; for doses or &quot;UVI&quot;,</span>
<span class="sd">        &quot;W m-2&quot; or &quot;mW m-2&quot; for irradiances. Defaults to &quot;SED&quot;.</span>

<span class="sd">    exposure_schedule : array</span>
<span class="sd">        A vector of values describing the relative exposure of each hour of the day. 0 indicates no</span>
<span class="sd">        exposure, 1 indicates full exposure, and a fractional value such as 0.5 would indicate </span>
<span class="sd">        exposure for a total of 30 minutes within the hour, or a 50% partial exposure for the full</span>
<span class="sd">        hour, or anything equivalent. Values greater than 1 are allowed. Must have a length of 24 (for </span>
<span class="sd">        each hour of the day) although a length of 1 is also allowed, in which case that number will </span>
<span class="sd">        be immediately replicated across a 24-length vector. When not calculating doses, hours with </span>
<span class="sd">        any non-zero entry in this vector are included, with the irradiance values being </span>
<span class="sd">        multiplied by the corresponding non-zero value in the exposure schedule.</span>

<span class="sd">    bin_width : float</span>
<span class="sd">        The width of each bin in the pixel histogram. Value assumed to be in the same units as </span>
<span class="sd">        defined by the units parameter. *Making bin_width excessively small can lead to high</span>
<span class="sd">        memory usage,* consider the underlying accuracy of the source data and be sure not to</span>
<span class="sd">        substantially exceed its precision with this parameter.</span>

<span class="sd">    statistic : str</span>
<span class="sd">        The statistical descriptor to be calculated from the pixel histograms to be later </span>
<span class="sd">        represented on the rendered map. Must contain at least one of these keywords:</span>
<span class="sd">        &quot;mean&quot;, &quot;median&quot; or &quot;med&quot;, &quot;sd&quot; or &quot;std&quot; or &quot;stdev&quot;, &quot;max&quot; or &quot;maximum&quot;, &quot;min&quot; or </span>
<span class="sd">        &quot;minimum&quot;. </span>

<span class="sd">        *Planned:* the string can be a formula using any of the keywords above,</span>
<span class="sd">        as well at &quot;prct&quot; or &quot;percentile&quot; preceeded by a number between 0 and 100, and </span>
<span class="sd">        basic mathematical operators (+, -, *, /, **) and numeric factors.</span>

<span class="sd">    date_selection : list of dates</span>
<span class="sd">        The dates for which the irradiances are retrieved or the daily doses are calculated. </span>
<span class="sd">        Defaults to None whereby the program selects all data within the src_directory that</span>
<span class="sd">        matches the src_filename_format.</span>

<span class="sd">    src_filename_format : str</span>
<span class="sd">        Describes the filename of the netCDF files containing the data with &#39;yyyy&#39; in place </span>
<span class="sd">        of the year.</span>
<span class="sd">    </span>
<span class="sd">    src_directory : str</span>
<span class="sd">        The directory where the data is stored. Must end with a slash.</span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    The code below shows a typical use case for the ExposureMap class. The long-term average daily doses</span>
<span class="sd">    (i.e. the chronic doses) for typical school children are calculated across Switzerland asssuming certain</span>
<span class="sd">    hours of exposure for journeying to and from school and having breaks for morning tea and lunch time. ::</span>

<span class="sd">        import python_tamer as pt</span>
<span class="sd">        import pandas as pd</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        src_directory = &#39;C:/enter_your_src_directory_here&#39;</span>
<span class="sd">        ER = pt.ER_Vernez_2015(&quot;Forehead&quot;,&quot;Standing&quot;) # Long-term average ER for foreheads in standing posture</span>
<span class="sd">        map = pt.ExposureMap(</span>
<span class="sd">            src_directory=src_directory,</span>
<span class="sd">            units = &quot;J m-2&quot;,</span>
<span class="sd">            exposure_schedule = np.array([0  ,0  ,0  ,0  ,0  ,0  ,</span>
<span class="sd">                                0  ,0  ,0.5,0  ,0.5,0  ,</span>
<span class="sd">                                0.5,0.5,0  ,0  ,0.5,0  ,</span>
<span class="sd">                                0  ,0  ,0  ,0  ,0  ,0  ])*ER,</span>
<span class="sd">            bin_width = 25,</span>
<span class="sd">            date_selection = pd.date_range(start=&quot;2005-01-01&quot;,end=&quot;2014-12-31&quot;),</span>
<span class="sd">            statistic = &quot;mean&quot;,</span>
<span class="sd">            map_options={&quot;title&quot;: &quot;Chronic daily UV dose for typical school children, 2005-2014&quot;,</span>
<span class="sd">                        &quot;save&quot;: False})</span>
<span class="sd">        map = map.collect_data().calculate_map()</span>
<span class="sd">        map.plot_map()</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;SED&quot;</span><span class="p">,</span>
    <span class="n">exposure_schedule</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">date_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">map_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">src_filename_format</span><span class="o">=</span><span class="s1">&#39;UVery.AS_ch02.lonlat_yyyy01010000.nc&#39;</span><span class="p">,</span>
    <span class="n">src_directory</span><span class="o">=</span><span class="s1">&#39;C:/Data/UV/&#39;</span><span class="p">):</span>
        <span class="c1"># assigning options to fields in class with a few basic checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exposure_schedule</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span> <span class="o">=</span> <span class="n">statistic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span> <span class="p">:</span> <span class="s2">&quot;Test map&quot;</span><span class="p">,</span>
            <span class="s2">&quot;save&quot;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;img_size&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span>
            <span class="s2">&quot;img_dpi&quot;</span> <span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
            <span class="s2">&quot;img_dir&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;img_filename&quot;</span> <span class="p">:</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;img_filetype&quot;</span> <span class="p">:</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span>
            <span class="s2">&quot;brdr_nation&quot;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;brdr_nation_rgba&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;brdr_state&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;brdr_state_rgba&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.67</span><span class="p">],</span>
            <span class="s2">&quot;cmap&quot;</span> <span class="p">:</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cmap_limits&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;cbar&quot;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;cbar_limits&quot;</span> <span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">map_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">map_options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span> <span class="o">=</span> <span class="n">src_filename_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_directory</span> <span class="o">=</span> <span class="n">src_directory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">date_selection</span> <span class="o">=</span> <span class="n">date_selection</span>

        <span class="k">if</span> <span class="n">bin_width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;SED&quot;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
                <span class="s2">&quot;J m-2&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
                <span class="s2">&quot;UVI&quot;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
                <span class="s2">&quot;W m-2&quot;</span> <span class="p">:</span> <span class="mf">0.0025</span><span class="p">,</span> 
                <span class="s2">&quot;mW m-2&quot;</span> <span class="p">:</span> <span class="mf">2.5</span>
            <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_width</span>
        
    
<div class="viewcode-block" id="ExposureMap.collect_data"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMap.collect_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">src_filename_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">date_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exposure_schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bin_width</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads and manipulates data into histograms for each pixel of the underlying data</span>

<span class="sd">        In order to handle large amounts of data without exceeding memory limitations, files are</span>
<span class="sd">        loaded one at a time and the time dimension is removed, either by calculating daily doses</span>
<span class="sd">        or by simply taking the data as is. The resulting information is then stored not as a </span>
<span class="sd">        list of specific values but rather binned into a histogram for each pixel. This process</span>
<span class="sd">        is repeated for each file required by the user input, building up the pixel histograms</span>
<span class="sd">        with more information that does not require additional memory.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        src_filename_format : str</span>
<span class="sd">            Describes the filename of the netCDF files containing the data with &#39;yyyy&#39; in place </span>
<span class="sd">            of the year.</span>
<span class="sd">        </span>
<span class="sd">        src_directory : str</span>
<span class="sd">            The directory where the data is stored. Must end with a slash.</span>

<span class="sd">        date_selection : list of dates</span>
<span class="sd">            The dates for which the irradiances are retrieved or the daily doses are calculated. </span>
<span class="sd">            Defaults to None whereby the program selects all data within the src_directory that</span>
<span class="sd">            matches the src_filename_format.</span>

<span class="sd">        units : str</span>
<span class="sd">            Name of units of desired output. This also indicates whether daily doses must be </span>
<span class="sd">            calculated or not. Units of &quot;SED&quot;, &quot;J m-2&quot;, or &quot;UVIh&quot; will produce daily doses,</span>
<span class="sd">            units of &quot;UVI&quot;, &quot;W m-2&quot; or &quot;mW m-2&quot; will not. </span>

<span class="sd">        exposure_schedule : array</span>
<span class="sd">            A vector of values describing the relative exposure of each hour of the day. 0 indicates no</span>
<span class="sd">            exposure, 1 indicates full exposure, and a fractional value such as 0.5 would indicate </span>
<span class="sd">            exposure for a total of 30 minutes within the hour, or a 50% partial exposure for the full</span>
<span class="sd">            hour, or anything equivalent. Values greater than 1 are allowed. Must have a length of 24 (for </span>
<span class="sd">            each hour of the day) although a length of 1 is also allowed, in which case that number will </span>
<span class="sd">            be immediately replicated across a 24-length vector. When not calculating doses, hours with </span>
<span class="sd">            any non-zero entry in this vector are included, with the irradiance values being </span>
<span class="sd">            multiplied by the corresponding non-zero value in the exposure schedule.</span>

<span class="sd">        bin_width : float</span>
<span class="sd">            The width of each bin in the pixel histogram. Value assumed to be in the same units as </span>
<span class="sd">            defined by the units parameter. *Making bin_width excessively small can lead to high</span>
<span class="sd">            memory usage,* consider the underlying accuracy of the source data and be sure not to</span>
<span class="sd">            substantially exceed its precision with this parameter.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        python_tamer.ExposureMap</span>
<span class="sd">            The input ExposureMap object is appended with new fields, `pix_hist` contains</span>
<span class="sd">            the counts for the histogram, and `bin_edges`, `bin_centers`, and `num_bins`</span>
<span class="sd">            all serve as metadata for the pixel histograms. `lat` and `lon` are also </span>
<span class="sd">            added from the multi-file dataset to inform the pixel locations for map making</span>
<span class="sd">            further down the typical pipeline.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        The example code below shows how an ExposureMap class can be declared with the default parameters that</span>
<span class="sd">        can then be later redefined by collect_data() and the other class functions. ::</span>

<span class="sd">            import python_tamer as pt</span>
<span class="sd">            import pandas as pd</span>
<span class="sd">            import numpy as np</span>
<span class="sd">            src_directory = &#39;C:/enter_your_src_directory_here&#39;</span>
<span class="sd">            ER = pt.ER_Vernez_2015(&quot;Forehead&quot;,&quot;Standing&quot;) # Long-term average ER for foreheads in standing posture</span>
<span class="sd">            map = pt.ExposureMap()</span>
<span class="sd">            map = map.collect_data(</span>
<span class="sd">                src_directory=src_directory,</span>
<span class="sd">                units = &quot;J m-2&quot;,</span>
<span class="sd">                exposure_schedule = np.array([0  ,0  ,0  ,0  ,0  ,0  ,</span>
<span class="sd">                                     0  ,0  ,0.5,0  ,0.5,0  ,</span>
<span class="sd">                                     0.5,0.5,0  ,0  ,0.5,0  ,</span>
<span class="sd">                                     0  ,0  ,0  ,0  ,0  ,0  ])*ER,</span>
<span class="sd">                bin_width = 25,</span>
<span class="sd">                date_selection = pd.date_range(start=&quot;2005-01-01&quot;,end=&quot;2014-12-31&quot;)</span>
<span class="sd">            )</span>
<span class="sd">            map = map.calculate_map(statistic = &quot;mean&quot;)</span>
<span class="sd">            map.plot_map(map_options={&quot;title&quot;: &quot;Chronic daily UV dose for typical school children, 2005-2014&quot;,</span>
<span class="sd">                                      &quot;save&quot;: False})</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: There must be a better way to do this</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">src_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_directory</span> <span class="o">=</span> <span class="n">src_directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">src_filename_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span> <span class="o">=</span> <span class="n">src_filename_format</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">date_selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_selection</span> <span class="o">=</span> <span class="n">date_selection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">exposure_schedule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="n">exposure_schedule</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bin_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_width</span>

        <span class="c1"># first we read the src_directory to check the total number of unique years available</span>
        <span class="n">data_dir_contents</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_directory</span><span class="p">)</span>
        <span class="c1"># TODO: improve jankiness of this format-matching search for filenames</span>
        <span class="n">char_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;yyyy&#39;</span><span class="p">)</span>
        <span class="n">dataset_years</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_dir_contents</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;yyyy&quot;</span><span class="p">,</span><span class="s2">&quot;[0-9]</span><span class="si">{4}</span><span class="s2">&quot;</span><span class="p">),</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">dataset_years</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">char_year</span><span class="p">:</span><span class="n">char_year</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataset_years</span> <span class="p">]</span>

        <span class="c1"># Now we can handle default options like &quot;all&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_selection</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_selection</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="p">:</span>
            <span class="n">date_selection</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_years</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;-01-01&quot;</span><span class="p">,</span>
                <span class="n">end</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;-12-31&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">date_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_selection</span> <span class="c1"># TODO: much more interpretation options here</span>

        <span class="c1">#now we find unique years </span>
        <span class="n">list_of_years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">date_selection</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_years</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">list_of_years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing year &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span> <span class="c1">#should use logging, don&#39;t yet know how</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_directory</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;yyyy&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)))</span> 
            <span class="n">dataset</span><span class="o">.</span><span class="n">set_auto_mask</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#to get normal arrays (faster than default masked arrays)</span>

            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">24</span> <span class="p">:</span>
                <span class="c1"># needed if just a single day</span>
                <span class="n">time_subset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="c1"># Next we pull a subset from the netCDF file</span>
                <span class="c1"># declare false array with same length of time dimension from netCDF</span>
                <span class="n">time_subset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span> 
                <span class="c1"># reshape false array to have first dimension 24 (hours in day)</span>
                <span class="n">time_subset</span> <span class="o">=</span> <span class="n">assert_data_shape_24</span><span class="p">(</span><span class="n">time_subset</span><span class="p">)</span> 
                <span class="c1"># set the appropriate days as true</span>
                <span class="n">time_subset</span><span class="p">[:,</span><span class="n">date_selection</span><span class="p">[</span><span class="n">date_selection</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> 
                <span class="c1"># flatten time_subset array back to one dimension</span>
                <span class="n">time_subset</span> <span class="o">=</span> <span class="n">time_subset</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

            <span class="c1"># load subset of data</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Slicing netcdf data with time subset&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;UV_AS&#39;</span><span class="p">][</span><span class="n">time_subset</span><span class="p">,:,:]</span> <span class="c1">#work in UVI by default because it&#39;s easy to read</span>
            <span class="c1"># TODO: check units of dataset files, CF conventions for UVI or W/m2</span>

            <span class="c1"># now to calculate doses if requested</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SED&quot;</span><span class="p">,</span><span class="s2">&quot;J m-2&quot;</span><span class="p">,</span><span class="s2">&quot;UVIh&quot;</span><span class="p">]</span> <span class="p">:</span>
                <span class="c1"># if calculating doses</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Calculating doses&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">assert_data_shape_24</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,[</span><span class="mi">24</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="p">:</span>
                <span class="c1"># assume elsewise calculating intensity (i.e. UV-index) then limit data selection according</span>
                <span class="c1"># to schedule (remembering that default schedule is just ones)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Slicing data with exposure schedule&#39;</span><span class="p">)</span>
                <span class="c1"># reshape so first dimension is 24 hours</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">assert_data_shape_24</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># select only those hours with nonzero entry in exposure schedule</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,:,:,:]</span>
                <span class="c1"># select nonzero values from exposure schedule</span>
                <span class="n">exposure_schedule_nonzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

                <span class="c1"># if any nonzero entries aren&#39;t 1, multiply data accordingly</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">exposure_schedule_nonzero</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="p">:</span>
                    <span class="n">data</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">exposure_schedule_nonzero</span><span class="p">,[</span><span class="nb">len</span><span class="p">(</span><span class="n">exposure_schedule_nonzero</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># recombine first two dimensions (hour and day) back into time ready for histogram</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">assert_data_shape_24</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

            <span class="c1"># now multiply data by conversion factor according to desired untis</span>
            <span class="c1"># TODO: Should expand upon this in reference files</span>
            <span class="n">data</span> <span class="o">*=</span> <span class="p">{</span><span class="s2">&quot;SED&quot;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">,</span> <span class="s2">&quot;J m-2&quot;</span><span class="p">:</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;UVIh&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;UVI&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;W m-2&quot;</span><span class="p">:</span><span class="mf">0.025</span><span class="p">,</span> <span class="s2">&quot;mW m-2&quot;</span><span class="p">:</span><span class="mi">25</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">]</span>

            <span class="c1"># if this is the first iteration, declare a hist</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="c1"># seems like useful metadata to know bin n and edges</span>
                <span class="c1"># TODO: reconsider where this belongs in the code (__init__?)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> 
                <span class="c1"># this form allows for weird custom bin edges, but probably will never use that</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>

                <span class="c1"># TODO: think about possible cases where dimensions could differ</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

                <span class="c1"># TODO: this should also be done by some initial dataset analysis, but that&#39;s a drastic</span>
                <span class="c1"># design overhaul</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]</span>

            <span class="k">else</span> <span class="p">:</span>
                <span class="n">new_num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span>
                <span class="c1"># check if new data requires extra bins in pix_hist</span>
                <span class="k">if</span> <span class="n">new_num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="c1"># append zeros to pix hist to make room for larger values</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">new_num_bins</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># update bin information</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">+</span> <span class="n">new_num_bins</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>

            <span class="c1"># TODO: Add check in case bins get &quot;full&quot; (i.e. approach int16 max value)</span>
            <span class="c1"># now put data into hist using apply_along_axis to perform histogram for each pixel</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Calculating and adding to pixel histograms&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span><span class="p">[:,:,:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ExposureMap.calculate_map"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMap.calculate_map">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pix_hist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">statistic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bin_centers</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculates statistical descriptor values for pixel histograms to produce a map</span>

<span class="sd">        This function interprets the statistic string, which can either be a simple command</span>
<span class="sd">        such as &quot;mean&quot; or a more advanced formula of keywords. The corresponding function is </span>
<span class="sd">        applied to each pixel of the pix_hist object within the ExposureMap class, essentially</span>
<span class="sd">        removing the first dimension and resulting in straightforward map to be plotted.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        pix_hist : array</span>
<span class="sd">            A 3D array with the first dimension containing vectors of counts for histograms</span>
<span class="sd">            and the next two dimensions serving as pixel coordinates. See </span>
<span class="sd">            `ExposureMap.collect_data()` for more information.</span>

<span class="sd">        statistic : str</span>
<span class="sd">            The statistical descriptor to be calculated from the pixel histograms to be later </span>
<span class="sd">            represented on the rendered map. Must contain at least one of these keywords:</span>
<span class="sd">            &quot;mean&quot;, &quot;median&quot; or &quot;med&quot;, &quot;sd&quot; or &quot;std&quot; or &quot;stdev&quot;, &quot;max&quot; or &quot;maximum&quot;, &quot;min&quot; or </span>
<span class="sd">            &quot;minimum&quot;. </span>

<span class="sd">            *Planned:* the string can be a formula using any of the keywords above,</span>
<span class="sd">            as well at &quot;prct&quot; or &quot;percentile&quot; preceeded by a number between 0 and 100, and </span>
<span class="sd">            basic mathematical operators (+, -, *, /, **) and numeric factors.</span>
<span class="sd">            </span>
<span class="sd">        bin_centers : array</span>
<span class="sd">            The central numeric values corresponding to the bins in pix_hist. The </span>
<span class="sd">            `ExposureMap.collect_data` function typically calculates these values from the</span>
<span class="sd">            given `bin_width` input.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        python_tamer.ExposureMap</span>
<span class="sd">            The ExposureMap class object is appended with a map field containing a 2D array</span>


<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        In the example below, the user imports some pre-calculated pixel histograms, thereby</span>
<span class="sd">        completing the ExposureMap workflow without using the `ExposureMap.ExposureMap.collect_data()`</span>
<span class="sd">        function. This can be useful if the data collection is timely and the user wants to</span>
<span class="sd">        produce multiple different maps. Note that the &quot;custom data&quot; used in this example is not</span>
<span class="sd">        included in the python-TAMER package, this simply illustrates a unique use-case. ::</span>

<span class="sd">            import python_tamer as pt</span>
<span class="sd">            # load custom data from an external file (not included)</span>
<span class="sd">            from custom_user_data import pix_hist, bin_centers, map_options </span>
<span class="sd">            map = pt.ExposureMap(map_options = map_options)</span>
<span class="sd">            map = map.calculate_map(</span>
<span class="sd">                statistic = &quot;median&quot;, </span>
<span class="sd">                pix_hist = data, </span>
<span class="sd">                bin_centers = bin_centers</span>
<span class="sd">            ).plot_map(save = False)</span>
<span class="sd">            map.calculate_map(statistic = &quot;max&quot;).plot_map(map_options={&quot;save&quot; = False})</span>
<span class="sd">            map.calculate_map(statistic = &quot;std&quot;).plot_map(map_options={&quot;save&quot; = False})</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pix_hist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span> <span class="o">=</span> <span class="n">pix_hist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">statistic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span> <span class="o">=</span> <span class="n">statistic</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span> <span class="o">=</span> <span class="n">bin_centers</span>

        <span class="c1"># Begin by defining the easy options that only require two inputs</span>
        <span class="n">basic_descriptor_functions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">hist_mean</span><span class="p">,</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">hist_percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="s2">&quot;med&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">hist_percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="n">hist_stdev</span><span class="p">,</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">hist_stdev</span><span class="p">,</span>
            <span class="s2">&quot;stdev&quot;</span><span class="p">:</span> <span class="n">hist_stdev</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">hist_max</span><span class="p">,</span>
            <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="n">hist_max</span><span class="p">,</span>
            <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">hist_min</span><span class="p">,</span>
            <span class="s2">&quot;minimum&quot;</span><span class="p">:</span><span class="n">hist_min</span>
        <span class="p">}</span>
        <span class="c1"># we can check if the chosen statistic is basic or advanced</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">basic_descriptor_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
            <span class="c1"># in this case, we can simply select the basic function from the dict...</span>
            <span class="n">descriptor_function</span> <span class="o">=</span> <span class="n">basic_descriptor_functions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="c1"># ...and execute it across the map</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">descriptor_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span><span class="p">)</span>
        <span class="c1"># TODO: a loose space could ruin this, need shunting yard algorithm of sorts</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;prct&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;percentile&quot;</span> <span class="p">:</span>
            <span class="n">prct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hist_percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span><span class="n">prct</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_hist</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="c1"># TODO: interpret self.statistic to build advanced functions (y i k e s)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: ExposureMap.statistic not recognised.&quot;</span><span class="p">)</span>
        

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ExposureMap.plot_map"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMap.plot_map">[docs]</a>    <span class="k">def</span> <span class="nf">plot_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">map_options</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Renders and optionally saves a map of the ``map`` field in an ExposureMap object</span>

<span class="sd">        This function caps off the typical workflow for the ExposureMap class by rendering the contents</span>
<span class="sd">        of the map field. Many aesthetic factors are accounted for, contained within the</span>
<span class="sd">        `ExposureMap.map_options` dictionary.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        map_options : dict, optional</span>
<span class="sd">            A collection of many typical options such as image and font sizes, colormaps, etc.</span>
<span class="sd">            The full range of options is listed below with their default values.</span>

<span class="sd">            &quot;title&quot; : &quot;Test map&quot; </span>
<span class="sd">            The title to be rendered above the map. Can be left blank for no title. Can be </span>
<span class="sd">            used to inform img_filename</span>

<span class="sd">            &quot;save&quot; : True </span>
<span class="sd">            Boolean to declare whether the map should be saved as an image file or not.</span>
<span class="sd">            </span>
<span class="sd">            &quot;img_size&quot; : [20,15] </span>
<span class="sd">            The size [width,height] of the image in cm.</span>

<span class="sd">            &quot;img_dpi&quot; : 300 </span>
<span class="sd">            The dots per inch of the saved image.</span>

<span class="sd">            &quot;img_dir&quot; : &quot;&quot; </span>
<span class="sd">            The directory for the image to be saved in, leaving it blank should result</span>
<span class="sd">            in images being saved in the working directory.</span>

<span class="sd">            &quot;img_filename&quot; : &quot;timestamp&quot; </span>
<span class="sd">            The image filename as a string. The default value of &quot;timestamp&quot; is a keyword</span>
<span class="sd">            indicating that the function should generate a filename based on the time at</span>
<span class="sd">            the moment of the calculation, specified with the format %Y%m%d_%H%M%S_%f </span>
<span class="sd">            which includes millisecond precision.</span>

<span class="sd">            &quot;img_filetype&quot; : &quot;png&quot; </span>
<span class="sd">            The image filetype, must be acceptable to `matplotlib.pyplot.savefig()`.</span>

<span class="sd">            &quot;brdr_nation&quot; : True </span>
<span class="sd">            Boolean for drawing national borders on the map.</span>

<span class="sd">            &quot;brdr_nation_rgba&quot; : [0,0,0,0] </span>
<span class="sd">            The red, green, blue, and alpha values for the national borders.</span>

<span class="sd">            &quot;brdr_state&quot; : False </span>
<span class="sd">            Boolean for drawing state borders as defined by Natural Earth dataset.</span>

<span class="sd">            &quot;brdr_state_rgba&quot; : [0,0,0,0.67] </span>
<span class="sd">            The red, green, blue, and alpha values for the national borders.</span>

<span class="sd">            &quot;cmap&quot; : &quot;jet&quot; </span>
<span class="sd">            The name of the colourmap to be used when rendering the map.</span>

<span class="sd">            &quot;cmap_limits&quot; : None </span>
<span class="sd">            The numeric limits of the colourmap. Defaults to None, where the lower</span>
<span class="sd">            and upper limits of the plotted data are used as the colourmap limits.</span>

<span class="sd">            &quot;cbar&quot; : True </span>
<span class="sd">            Boolean for rendering a colourbar.</span>

<span class="sd">            &quot;cbar_limits&quot; : None </span>
<span class="sd">            The numeric limits of the colourbar. Defaults to None, where the lower</span>
<span class="sd">            and upper limits of the plotted data are used as the colourbar limits.</span>
<span class="sd">        </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        python_tamer.ExposureMap</span>
<span class="sd">            Returns the ExposureMap object that was input with an updated map_options</span>
<span class="sd">            field (if the user has specificied any changes to the default map_options).</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">map_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">map_options</span><span class="p">)</span>

        <span class="c1"># TODO: Add custom sizing and resolution specifications</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.54</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.54</span><span class="p">))</span>

        <span class="c1"># TODO: Accept custom projections</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Mercator</span><span class="p">()</span>

        <span class="c1"># TODO: Add support for multiple plots per figure (too complex? consider use cases)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">projection</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

        <span class="c1"># TODO: Increase flexibility of borders consideration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;brdr_nation&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeat</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">)</span>

        <span class="c1"># TODO: Consider first-last versus min-max - how can we avoid accidentally flipping images</span>
        <span class="n">extents</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extents</span><span class="p">)</span>

        <span class="c1"># Confusingly, this code correctly translate the lat/lon limits into the projected coordinates</span>
        <span class="n">extents_proj</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">extents</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="n">extents_proj</span> <span class="o">=</span> <span class="n">extents_proj</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

        <span class="c1"># TODO: Custom colormaps, interpolation, cropping</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="n">extents_proj</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bicubic&#39;</span><span class="p">)</span>

        <span class="c1"># TODO: Add more advanced title interpretation (i.e. smart date placeholder)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>

        <span class="c1"># TODO: Add support for horizontal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;cbar&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># TODO: Add plot title, small textbox description, copyright from dataset, ticks and gridlines</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="c1"># Generate timestamp filename if relying on default</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;img_filename&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span>
                <span class="n">img_filename</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S_</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;img_dir&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">img_filename</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;img_filetype&#39;</span><span class="p">],</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;img_dpi&#39;</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>












<div class="viewcode-block" id="ExposureMapSequence"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMapSequence">[docs]</a><span class="k">class</span> <span class="nc">ExposureMapSequence</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Class for generating multiple Exposure Maps in a single operation</span>

<span class="sd">    The ExposureMapSequence class is a framework for generating multiple maps following</span>
<span class="sd">    a given sequence. The basic workflow begins by declaring an object of this class and</span>
<span class="sd">    collecting the data from the source NetCDF files. The process is designed with </span>
<span class="sd">    memory efficiency in mind, so data is loaded one year at a time and put into pixel</span>
<span class="sd">    histograms akin to the ExposureMap class behaviour. However, in this class we allow for</span>
<span class="sd">    multiple histograms to be stored within a single ExposureMapSequence object. Next,</span>
<span class="sd">    the maps are calculated by the calculate_maps function. Multiple maps can be calculated for each histogram if the user</span>
<span class="sd">    has specified multiple statistics that they want to calculate. Lastly, the maps are</span>
<span class="sd">    rendered and saved by the save_maps function.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    src_filename_format : str</span>
<span class="sd">        Describes the filename of the netCDF files containing the data with &#39;yyyy&#39; in place </span>
<span class="sd">        of the year.</span>
<span class="sd">    </span>
<span class="sd">    src_directory : str</span>
<span class="sd">        The directory where the data is stored. Must end with a slash.</span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    In this example, we produce a basic sequence of monthly average doses for 2020::</span>

<span class="sd">        example = ExposureMapSequence()</span>
<span class="sd">        example = example.collect_data(&#39;monthly&#39;,year_selection=[2020],units=[&quot;SED&quot;])</span>
<span class="sd">        example = example.calculate_maps(statistic=&#39;Mean&#39;)</span>
<span class="sd">        example.save_maps(save=True,show=True)</span>

<span class="sd">    In this example, we produce a basic sequence of annual average doses for each year</span>
<span class="sd">    of the dataset::</span>

<span class="sd">        example = ExposureMapSequence()</span>
<span class="sd">        example = example.collect_data([&#39;annual&#39;],year_selection=[0],units=[&quot;SED&quot;])</span>
<span class="sd">        example = example.calculate_maps(statistic=&#39;Mean&#39;)</span>
<span class="sd">        example.save_maps(save=True,show=True)        </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">src_filename_format</span><span class="o">=</span><span class="s1">&#39;UVery.AS_ch02.lonlat_yyyy01010000.nc&#39;</span><span class="p">,</span>
    <span class="n">src_directory</span><span class="o">=</span><span class="s1">&#39;C:/Data/UV/&#39;</span><span class="p">,</span>
    <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bin_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">map_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># start with data location to quickly get some metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span> <span class="o">=</span> <span class="n">src_filename_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_directory</span> <span class="o">=</span> <span class="n">src_directory</span>

        <span class="c1"># first we read the src_directory to check the total number of unique years available</span>
        <span class="n">data_dir_contents</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_directory</span><span class="p">)</span>

        <span class="c1"># match filename format to find years</span>
        <span class="n">dataset_years</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_dir_contents</span> 
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;yyyy&quot;</span><span class="p">,</span><span class="s2">&quot;[1-2][0-9]</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="p">),</span><span class="n">x</span><span class="p">)]</span>

        <span class="n">char_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;yyyy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_years</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">char_year</span><span class="p">:</span><span class="n">char_year</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataset_years</span> <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>

        <span class="c1"># declare an empty dictionary for map options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="o">=</span><span class="p">{}</span>
        <span class="c1"># if any input, update dictionary</span>
        <span class="k">if</span> <span class="n">map_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">map_options</span><span class="p">)</span>


<div class="viewcode-block" id="ExposureMapSequence.interpret_parameters"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMapSequence.interpret_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">interpret_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interprets some parameter inputs and adjusts for consistency</span>

<span class="sd">        This function will check that parameters are correctly entered and do some basic interpretation.</span>
<span class="sd">        It checks the exposure_schedule, year_selection, units, and bin_width input. All input is converted</span>
<span class="sd">        to lists as required.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;exposure_schedule&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="mi">24</span><span class="p">)]</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">temp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">temp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">24</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">24</span> <span class="p">:</span>
                    <span class="c1"># split an array of multiple schedules into a list of single schedule arrays</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exposure schedule not a comprehensible numpy array, &quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;must be length 24 in first or second dimension&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">)</span> <span class="o">==</span> <span class="mi">24</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">)</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">)]</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">))</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">24</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">temp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">dict</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">temp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span> 
                                <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">24</span> <span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exposure schedule list contains an incomprehensible entry, &quot;</span> <span class="o">+</span> 
                                            <span class="s2">&quot;a numpy array that is not length 24&quot;</span><span class="p">)</span>
                    
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">24</span> <span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exposure schedule list contains an incomprehensible entry, &quot;</span> <span class="o">+</span> 
                                            <span class="s2">&quot;a list that is not length 24&quot;</span><span class="p">)</span>
                    
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Exposure schedule list contains an incomprehensible entry&quot;</span><span class="p">)</span>

            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Exposure schedule must be a list of length-24 numpy arrays or similar&quot;</span><span class="p">)</span>
        <span class="c1">######################################################################################################            </span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;year_selection&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_years</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Year selection should be a list of numpy arrays, &quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;provided numpy array has incomprehensible shape&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">!=</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">)</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">)]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">))</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_years</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> 
                                    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span> <span class="o">=</span> <span class="n">temp</span>
                                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span> <span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Year selection list must contain ints, lists, or numpy arrays&quot;</span><span class="p">)</span>
                        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Year selection must be an int, numpy array, or list of numpy arrays&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">))</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_years</span><span class="p">)</span>
        <span class="c1">#####################################################################################################</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Units input must be a list of strings&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Units input must be a list of strings&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">))</span> <span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Units input must be a list of strings&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SED&quot;</span><span class="p">,</span><span class="s2">&quot;UVIh&quot;</span><span class="p">,</span><span class="s2">&quot;UVI&quot;</span><span class="p">,</span><span class="s2">&quot;J m-2&quot;</span><span class="p">,</span><span class="s2">&quot;W m-2&quot;</span><span class="p">,</span><span class="s2">&quot;mW m-2&quot;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Units input must be list of accepted unit strings, &quot;</span> <span class="o">+</span>
                                     <span class="s2">&quot;those being SED, UVIh, J m-2, UVI, W m-2, or mW m-2&quot;</span><span class="p">)</span>


            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;bin_width&#39;</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;SED&quot;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
                            <span class="s2">&quot;J m-2&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
                            <span class="s2">&quot;UVI&quot;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> 
                            <span class="s2">&quot;W m-2&quot;</span> <span class="p">:</span> <span class="mf">0.0025</span><span class="p">,</span> 
                            <span class="s2">&quot;mW m-2&quot;</span> <span class="p">:</span> <span class="mf">2.5</span>
                            <span class="p">}[</span><span class="n">unit</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">]</span>


        <span class="k">return</span> <span class="bp">self</span></div>
        



<div class="viewcode-block" id="ExposureMapSequence.collect_data"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMapSequence.collect_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">day_selection</span><span class="p">,</span>
    <span class="n">exposure_schedule</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
    <span class="n">year_selection</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">units</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SED&quot;</span><span class="p">],</span>
    <span class="n">bin_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads data into multiple pixel histograms</span>

<span class="sd">        This function loads all of the necessary data and compiles it into one or</span>
<span class="sd">        multiple histograms. All parameters are designed to be interpreted as lists</span>
<span class="sd">        of arrays or lists of strings, where each list entry corresponding to a </span>
<span class="sd">        different histogram in the sequence. So to create a sequence of maps </span>
<span class="sd">        corresponding to the months of the year, the day_selection input would be a</span>
<span class="sd">        list of 12 arrays, the first containing numbers from 1 to 31, the second</span>
<span class="sd">        containing numbers from 32 to 59, and so on.</span>

<span class="sd">        The user specifies the day_selection and the year_selection as two separate </span>
<span class="sd">        numerical inputs, rather than specifying dates. This make the interpretation</span>
<span class="sd">        of the sequence simpler. However, to simplify the user experience, the </span>
<span class="sd">        day_selection input can include keywords to be automatically interpreted as</span>
<span class="sd">        days of the year.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        day_selection : list, str, array</span>
<span class="sd">            A list of arrays and/or strings. Keywords interpretable in such a list</span>
<span class="sd">            include the (english) names of the 12 months (at least the first three</span>
<span class="sd">            letters), the names of the four seasons (fall or autumn is accepted),</span>
<span class="sd">            or the words &quot;year&quot; or &quot;annual&quot; to indicate the full year. These </span>
<span class="sd">            keywords are replaced by the corresponding array of days in the year.</span>
<span class="sd">            Note that the 29th of February is removed from consideration should it </span>
<span class="sd">            arise. Note also that the seasons are the meteorological seasons, i.e.</span>
<span class="sd">            the three month blocks JJA, SON, DJF, and MAM for summer, autumn,</span>
<span class="sd">            winter, and spring respectively. </span>
<span class="sd">            </span>
<span class="sd">            The user can alternatively enter a special string instead of a list. </span>
<span class="sd">            The string &quot;monthly&quot; generates a list of 12 arrays according to the </span>
<span class="sd">            months whereas the string &quot;seasons&quot; generates a list of 4 arrays </span>
<span class="sd">            according to the four seasons. </span>

<span class="sd">        exposure_schedule : list, float, int, dict, array</span>
<span class="sd">            If the user enters a float, this float value will be repeated across a</span>
<span class="sd">            length-24 array to make the exposure schedule. For example, entering</span>
<span class="sd">            1.0 (not 1) will generate an array of 24 ones.</span>

<span class="sd">            If the user enters an int, i, a length-24 array of zeroes will be </span>
<span class="sd">            generated with the ith entry being set to 1. For example, entering 1 </span>
<span class="sd">            (not 1.0) will generate an array that reads [0,1,0,0...] (length 24).</span>

<span class="sd">            If the user enters a dict, they can specify the values of a few </span>
<span class="sd">            particular entries in a length-24 array where unspecified entries have</span>
<span class="sd">            a value of zero. For example, entering {0:0.5, 2:0.8, 3:1} will </span>
<span class="sd">            generate and array the reads [0.5, 0, 0.8, 1, 0...] (length 24).</span>

<span class="sd">            If the user enters an array, it must be 1 dimensional with length 24</span>
<span class="sd">            or 2 dimensional with the second dimension having length 24 (allowing</span>
<span class="sd">            the user to specify multiple schedules).</span>

<span class="sd">            If the user enters a list, each entry of that list is interpreted using</span>
<span class="sd">            the rules listed above, with the caveat that arrays within a list cannot</span>
<span class="sd">            be 2 dimensional.</span>
<span class="sd">            </span>

<span class="sd">        year_selection : list, array, int</span>
<span class="sd">            The years across which the data should be pulled. Input should be a list</span>
<span class="sd">            of arrays of ints corresponding to years available in the dataset. Each</span>
<span class="sd">            list entry corresponds to a pixel histogram. The user can enter 0 as a</span>
<span class="sd">            shortcut for using all available years. For example, an input might be</span>
<span class="sd">            [numpy.arange(2010,2020),[0],0]. The first list entry is an array of a</span>
<span class="sd">            decade of years, straightforward enough. The second list entry is [0]. </span>
<span class="sd">            This is equivalent to writing numpy.arange(2004,2021) i.e. it produces </span>
<span class="sd">            an array of the available years of the dataset. The last entry is 0,</span>
<span class="sd">            this produces a sequence of individual years. So the input could be</span>
<span class="sd">            equivalently written as [numpy.arange(2010,2020),numpy.arange(2004,2021),</span>
<span class="sd">            numpy.array([2004]),numpy.array([2005]),numpy.array([2006])...] and so</span>
<span class="sd">            on until 2020.</span>

<span class="sd">        units : list, optional</span>
<span class="sd">            The list of units for each pixel histogram. Acceptable strings are &quot;SED&quot;,</span>
<span class="sd">            &quot;J m-2&quot;, &quot;UVIh&quot;, &quot;UVI&quot;, &quot;W m-2&quot;, and &quot;mW m-2&quot;. Defaults to SED.</span>

<span class="sd">        bin_width : list, optional</span>
<span class="sd">            The bin width for each histogram. By default, these values are defined</span>
<span class="sd">            automatically according to the units input. </span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ExposureMapSequence</span>
<span class="sd">            The object has the hist_specs and hists fields added detailing the pixel</span>
<span class="sd">            histograms.</span>


<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        In this example, we produce a basic sequence of monthly average doses for 2020::</span>

<span class="sd">            example = ExposureMapSequence()</span>
<span class="sd">            example = example.collect_data(&#39;monthly&#39;,year_selection=[2020],units=[&quot;SED&quot;])</span>
<span class="sd">            example = example.calculate_maps(statistic=&#39;Mean&#39;)</span>
<span class="sd">            example.save_maps(save=True,show=True)</span>

<span class="sd">        In this example, we produce a basic sequence of annual average doses for each year</span>
<span class="sd">        of the dataset::</span>

<span class="sd">            example = ExposureMapSequence()</span>
<span class="sd">            example = example.collect_data([&#39;annual&#39;],year_selection=[0],units=[&quot;SED&quot;])</span>
<span class="sd">            example = example.calculate_maps(statistic=&#39;Mean&#39;)</span>
<span class="sd">            example.save_maps(save=True,show=True)   </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this subroutine handles keyword inputs (monthly, seasonal, etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">day_selection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_input_flt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_nonstring</span> <span class="o">=</span> <span class="n">str2daysofyear</span><span class="p">(</span><span class="n">day_selection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span> <span class="o">=</span> <span class="n">exposure_schedule</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span> <span class="o">=</span> <span class="n">year_selection</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        
        <span class="k">if</span> <span class="n">bin_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_width</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpret_parameters</span><span class="p">()</span>

        <span class="c1">############################################################################</span>

        <span class="n">lengths</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;day_selection&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">day_selection</span><span class="p">),</span>
                   <span class="s1">&#39;exposure_schedule&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">),</span>
                   <span class="s1">&#39;year_selection&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">),</span>
                   <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
                   <span class="s1">&#39;bin_width&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lengths</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="p">(</span>
            <span class="s2">&quot;Inputs must be lists of length 1 or num_hists&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">iterators</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lengths</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span><span class="p">]</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">hist_spec</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;day_selection&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;exposure_schedule&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_schedule</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;year_selection&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;bin_width&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterators</span> <span class="p">:</span>
                <span class="n">hist_spec</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span> <span class="o">+</span> <span class="p">[</span><span class="n">hist_spec</span><span class="p">]</span>
            
            
        <span class="c1"># find unique years to be loaded (probably all years but have to check)</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">unique_years</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_years</span><span class="p">)</span>

        <span class="c1"># declare empty hists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hists</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_years</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">unique_years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing year &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span> <span class="c1">#should use logging, don&#39;t yet know how</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_directory</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">src_filename_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;yyyy&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)))</span> 
            <span class="n">dataset</span><span class="o">.</span><span class="n">set_auto_mask</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#to get normal arrays (faster than default masked arrays)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="c1"># TODO: this should also be done by some initial dataset analysis, but that&#39;s a drastic</span>
                <span class="c1"># design overhaul</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]</span>

            <span class="c1"># now to determine the unique days for the specific year</span>
            <span class="n">unique_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;year_selection&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="n">unique_days</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;day_selection&#39;</span><span class="p">])</span>
            <span class="n">unique_days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_days</span><span class="p">)</span>

            <span class="c1"># TODO: when metadata fixed, update this to actually interpret dates (cftime)</span>
            <span class="c1"># reformat to index for netCDF</span>
            <span class="n">nc_day_sel</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">365</span><span class="o">*</span><span class="mi">24</span><span class="p">)]</span> 
            <span class="c1"># reshape false array to have first dimension 24 (hours in day)</span>
            <span class="n">nc_day_sel</span> <span class="o">=</span> <span class="n">assert_data_shape_24</span><span class="p">(</span><span class="n">nc_day_sel</span><span class="p">)</span> 
            <span class="c1"># set the appropriate days as true</span>
            <span class="n">nc_day_sel</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unique_days</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> 
            <span class="c1"># correct for leap years (skip feb 29)</span>
            <span class="k">if</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="n">nc_day_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">nc_day_sel</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">59</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">24</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="kc">False</span><span class="p">),</span><span class="n">nc_day_sel</span><span class="p">[:,</span><span class="mi">59</span><span class="p">:]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># flatten time_subset array back to one dimension</span>
            <span class="n">nc_day_sel</span> <span class="o">=</span> <span class="n">nc_day_sel</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

            <span class="c1">#load data</span>
            <span class="n">data_year</span> <span class="o">=</span> <span class="n">assert_data_shape_24</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;UV_AS&#39;</span><span class="p">][</span><span class="n">nc_day_sel</span><span class="p">,:,:])</span>

            <span class="c1">#sort data into histograms</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;year_selection&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="n">sub_day_sel</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;day_selection&#39;</span><span class="p">]</span> 
                        <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unique_days</span> <span class="p">]</span>
                    <span class="n">temp_data</span> <span class="o">=</span> <span class="n">data_year</span><span class="p">[:,</span><span class="n">sub_day_sel</span><span class="p">,:,:]</span>

                    <span class="c1"># Apply the exposure schedule, differently for doses vs intensity</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SED&quot;</span><span class="p">,</span><span class="s2">&quot;J m-2&quot;</span><span class="p">,</span><span class="s2">&quot;UVIh&quot;</span><span class="p">]</span> <span class="p">:</span>
                        <span class="c1"># if calculating doses</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Calculating doses&#39;</span><span class="p">)</span>
                        <span class="n">temp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;exposure_schedule&#39;</span><span class="p">],[</span><span class="mi">24</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">temp_data</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># more complex when doing intensity</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="c1"># assume elsewise calculating intensity (i.e. UV-index) then limit data selection</span>
                        <span class="c1"># to schedule (remembering that default schedule is just ones)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Slicing data with exposure schedule&#39;</span><span class="p">)</span>
                        <span class="c1"># select only those hours with nonzero entry in exposure schedule</span>
                        <span class="n">temp_data</span> <span class="o">=</span> <span class="n">temp_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;exposure_schedule&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,:,:,:]</span>
                        <span class="c1"># select nonzero values from exposure schedule</span>
                        <span class="n">exposure_schedule_nonzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;exposure_schedule&#39;</span><span class="p">][</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;exposure_schedule&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># if any nonzero entries aren&#39;t 1, multiply data accordingly</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">exposure_schedule_nonzero</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="p">:</span>
                            <span class="n">temp_data</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">exposure_schedule_nonzero</span><span class="p">,[</span><span class="nb">len</span><span class="p">(</span><span class="n">exposure_schedule_nonzero</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                        <span class="c1"># recombine first two dimensions (hour and day) back into time ready for histogram</span>
                        <span class="n">temp_data</span> <span class="o">=</span> <span class="n">assert_data_shape_24</span><span class="p">(</span><span class="n">temp_data</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

                    <span class="c1"># now multiply data by conversion factor according to desired untis</span>
                    <span class="c1"># TODO: Should expand upon this in reference files</span>
                    <span class="n">temp_data</span> <span class="o">*=</span> <span class="p">{</span><span class="s2">&quot;SED&quot;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">,</span> <span class="s2">&quot;J m-2&quot;</span><span class="p">:</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;UVIh&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;UVI&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;W m-2&quot;</span><span class="p">:</span><span class="mf">0.025</span><span class="p">,</span> <span class="s2">&quot;mW m-2&quot;</span><span class="p">:</span><span class="mi">25</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]]</span>

                    <span class="c1"># if this is the first iteration, declare a hist</span>
                    <span class="k">if</span> <span class="s1">&#39;num_bins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span>
                        <span class="c1"># seems like useful metadata to know bin n and edges</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;num_bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">temp_data</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_width&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;num_bins&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                            <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_width&#39;</span><span class="p">]</span> 
                        <span class="c1"># this form allows for weird custom bin edges, but probably will never use that</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_centers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
                            <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">]))</span>

                        <span class="c1"># TODO: think about possible cases where dimensions could differ</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;num_bins&#39;</span><span class="p">],</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">temp_data</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">temp_data</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">new_num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">temp_data</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_width&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;num_bins&#39;</span><span class="p">]</span>
                        <span class="c1"># check if new data requires extra bins in pix_hist</span>
                        <span class="k">if</span> <span class="n">new_num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                            <span class="c1"># append zeros to pix hist to make room for larger values</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">new_num_bins</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                            <span class="c1"># update bin information</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;num_bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;num_bins&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_num_bins</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;num_bins&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                                <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_width&#39;</span><span class="p">]</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_centers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
                                <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">]))</span>

                    <span class="c1"># TODO: Add check in case bins get &quot;full&quot; (i.e. approach int16 max value)</span>
                    <span class="c1"># now put data into hist using apply_along_axis to perform histogram for each pixel</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Calculating and adding to pixel histograms&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="n">j</span><span class="p">][:,:,:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">temp_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>                    </div>






<div class="viewcode-block" id="ExposureMapSequence.calculate_maps"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMapSequence.calculate_maps">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">statistic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filenames</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calcualte the maps from the pixel histograms </span>

<span class="sd">        This function calculates maps from the pixel histograms and generates</span>
<span class="sd">        titles and filenames for each map. Note that the number of maps can</span>
<span class="sd">        be greater than the number of pixel histograms if more than one </span>
<span class="sd">        statistic is specified.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        statistic : list, str</span>
<span class="sd">            The statistical descriptor to be calculated from the pixel histograms to be later </span>
<span class="sd">            represented on the rendered map. Must contain at least one of these keywords:</span>
<span class="sd">            &quot;mean&quot;, &quot;median&quot; or &quot;med&quot;, &quot;sd&quot; or &quot;std&quot; or &quot;stdev&quot;, &quot;max&quot; or &quot;maximum&quot;, &quot;min&quot; or </span>
<span class="sd">            &quot;minimum&quot;. The keyword &quot;prct&quot; or &quot;percentile&quot; is also accepted so long as it is</span>
<span class="sd">            preceded by a two-digit integer specifying the desired percentile from 01 to 99.</span>

<span class="sd">            *Planned:* the string can be a formula using any of the keywords above, and </span>
<span class="sd">            basic mathematical operators (+, -, *, /, **) and numeric factors.            </span>

<span class="sd">        titles : list, optional</span>
<span class="sd">            If the user does not wish to use the automatically generated map titles,</span>
<span class="sd">            they can enter them with this parameter. This must be a list of strings</span>
<span class="sd">            with a length equal to the number of maps produced.</span>

<span class="sd">        filenames : str, optional</span>
<span class="sd">            Filenames are generated to match the titles by default, but the user can</span>
<span class="sd">            alternatively enter them manually with this parameter.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ExposureMapSequence</span>
<span class="sd">            The object is appended with maps, map_specs, and num_maps fields.</span>


<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        In this example, we produce a basic sequence of annual average doses for each year</span>
<span class="sd">        of the dataset::</span>

<span class="sd">            example = ExposureMapSequence()</span>
<span class="sd">            example = example.collect_data([&#39;annual&#39;],year_selection=[0],units=[&quot;SED&quot;])</span>
<span class="sd">            example = example.calculate_maps(statistic=&#39;Mean&#39;)</span>
<span class="sd">            example.save_maps(save=True,show=True)   </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">statistic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span> <span class="o">=</span> <span class="n">statistic</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">]</span>
        
        <span class="c1"># declare array of nans to fill with maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">)]</span> <span class="o">+</span> 
            <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]),</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="n">titles</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">))]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filenames</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">))]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">filenames</span>


        <span class="n">mapnum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hist_inds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stat_inds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">))</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hists</span><span class="p">)</span> <span class="p">:</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">mapnum</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">calculate_map_from_hists</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hists</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bin_centers&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">filenames</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">mapnum</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">mapnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_map_title</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                            <span class="s1">&#39;statistic&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span><span class="n">filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">mapnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_map_title</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                            <span class="s1">&#39;statistic&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span><span class="n">filename</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">hist_inds</span> <span class="o">=</span> <span class="n">hist_inds</span> <span class="o">+</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">stat_inds</span> <span class="o">=</span> <span class="n">stat_inds</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">mapnum</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_maps</span> <span class="o">=</span> <span class="n">mapnum</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">map_specs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hist&#39;</span> <span class="p">:</span> <span class="n">hist_inds</span><span class="p">,</span> <span class="s1">&#39;statistic&#39;</span> <span class="p">:</span> <span class="n">stat_inds</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span></div>




<div class="viewcode-block" id="ExposureMapSequence.save_maps"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.ExposureMapSequence.save_maps">[docs]</a>    <span class="k">def</span> <span class="nf">save_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">map_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">match_cmap_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">schedule_diagram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Renders and saves the pre-calculated maps stored in the object</span>

<span class="sd">        With the maps calculated, this function renders the maps with broad flexibility on aesthetic </span>
<span class="sd">        options. It is mostly a wrapper for the render_map function.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        map_options : dict, optional</span>
<span class="sd">            A dictionary containing options for the render map function.</span>

<span class="sd">        save : bool, optional</span>
<span class="sd">            Although technically contained within map_options, this option is here so users can</span>
<span class="sd">            more easily say whether they want the images to be saved or not.</span>

<span class="sd">        show : bool, optional</span>
<span class="sd">            An option to show the maps in a python figure window or not.</span>

<span class="sd">        match_cmap_limits : bool, optional</span>
<span class="sd">            When producing multiple maps, it can sometimes be desirable for the colormap limits</span>
<span class="sd">            to be consistent across the set of images. This boolean enables that.</span>

<span class="sd">        schedule_diagram : bool, optional</span>
<span class="sd">            If true, a circular diagram is rendered on the map illustrating the schedule that</span>
<span class="sd">            generated the map.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">map_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">map_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save</span>

        <span class="k">if</span> <span class="n">match_cmap_limits</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;cmap_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;cmap_limits&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;cmap_limits&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span><span class="p">[</span><span class="s1">&#39;cmap_limits&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_maps</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_options</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;img_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">schedule_diagram</span> <span class="p">:</span>
                <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map_specs</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;exposure_schedule&#39;</span><span class="p">]</span>
            <span class="n">render_map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span>
                <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                <span class="n">cbar_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_specs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map_specs</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
                <span class="o">**</span><span class="n">opts</span><span class="p">)</span></div></div>







<div class="viewcode-block" id="render_map"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.render_map">[docs]</a><span class="k">def</span> <span class="nf">render_map</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span>
<span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">schedule_bbox</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.03</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.91</span><span class="p">),</span>
<span class="n">img_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">img_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="n">img_size</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span>
<span class="n">img_dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
<span class="n">img_filetype</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
<span class="n">brdr_nation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">brdr_nation_rgba</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
<span class="n">brdr_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">brdr_state_rgba</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.75</span><span class="p">],</span>
<span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gist_ncar&quot;</span><span class="p">,</span>
<span class="n">cmap_limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">cbar_limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">country_focus</span><span class="o">=</span><span class="s2">&quot;CHE&quot;</span><span class="p">,</span>
<span class="n">gridlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">gridlines_dms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="n">mch_logo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Renders and saves maps</span>

<span class="sd">    Renders and saves maps with a wide variety of aesthetic options.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    map : array</span>
<span class="sd">        The map to be rendered</span>
<span class="sd">    lat : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    lon : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    title : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    save : bool, optional</span>
<span class="sd">        [description], by default True</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        [description], by default True</span>
<span class="sd">    schedule : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    schedule_bbox : tuple, optional</span>
<span class="sd">        [description], by default (-0.03,0,1,0.91)</span>
<span class="sd">    img_filename : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    img_dir : str, optional</span>
<span class="sd">        [description], by default &quot;&quot;</span>
<span class="sd">    img_size : list, optional</span>
<span class="sd">        [description], by default [20,15]</span>
<span class="sd">    img_dpi : int, optional</span>
<span class="sd">        [description], by default 300</span>
<span class="sd">    img_filetype : str, optional</span>
<span class="sd">        [description], by default &quot;png&quot;</span>
<span class="sd">    brdr_nation : bool, optional</span>
<span class="sd">        [description], by default True</span>
<span class="sd">    brdr_nation_rgba : list, optional</span>
<span class="sd">        [description], by default [0,0,0,1]</span>
<span class="sd">    brdr_state : bool, optional</span>
<span class="sd">        [description], by default True</span>
<span class="sd">    brdr_state_rgba : list, optional</span>
<span class="sd">        [description], by default [0,0,0,0.75]</span>
<span class="sd">    cmap : str, optional</span>
<span class="sd">        [description], by default &quot;gist_ncar&quot;</span>
<span class="sd">    cmap_limits : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    cbar : bool, optional</span>
<span class="sd">        [description], by default True</span>
<span class="sd">    cbar_limits : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    cbar_label : [type], optional</span>
<span class="sd">        [description], by default None</span>
<span class="sd">    country_focus : str, optional</span>
<span class="sd">        [description], by default &quot;CHE&quot;</span>
<span class="sd">    gridlines : bool, optional</span>
<span class="sd">        [description], by default True</span>
<span class="sd">    gridlines_dms : bool, optional</span>
<span class="sd">        [description], by default False</span>
<span class="sd">    mch_logo : bool, optional</span>
<span class="sd">        [description], by default True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: Add custom sizing and resolution specifications</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.54</span><span class="p">,</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.54</span><span class="p">))</span>

    <span class="c1"># TODO: Accept custom projections</span>
    <span class="c1"># proj = ccrs.Mercator()</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">lon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">lat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># TODO: Add support for multiple plots per figure (too complex? consider use cases)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">projection</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

    <span class="c1"># TODO: Increase flexibility of borders consideration</span>
    <span class="k">if</span> <span class="n">brdr_state</span> <span class="p">:</span>
        <span class="n">state_brdrs</span> <span class="o">=</span> <span class="n">cfeat</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_1_states_provinces_lines&#39;</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">state_brdrs</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">brdr_state_rgba</span><span class="p">),</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">brdr_nation</span> <span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeat</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">brdr_nation_rgba</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">country_focus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">shpfilename</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_0_countries&#39;</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shpfilename</span><span class="p">)</span>
        <span class="n">countries</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">records</span><span class="p">()</span>    
        <span class="c1"># this is a very janky search for Switzerland, but it&#39;s ultimately simpler than</span>
        <span class="c1"># making geopandas a requirement for the library</span>
        <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">countries</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">country</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;ADM0_A3&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country_focus</span> <span class="p">:</span>
                <span class="k">break</span>
        <span class="k">assert</span> <span class="n">country</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;ADM0_A3&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country_focus</span><span class="p">,</span> <span class="s2">&quot;country_focus input not recognised&quot;</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">country</span><span class="o">.</span><span class="n">geometry</span>

        <span class="n">msk_proj</span>  <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">project_geometry</span> <span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">())</span>  <span class="c1"># project geometry to the projection used by stamen</span>

        <span class="c1"># plot the mask using semi-transparency (alpha=0.65) on the masked-out portion</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_geometries</span><span class="p">(</span> <span class="n">msk_proj</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

    <span class="c1"># TODO: Consider first-last versus min-max - how can we avoid accidentally flipping images</span>
    <span class="n">extents</span><span class="o">=</span><span class="p">[</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extents</span><span class="p">,</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">())</span>

    <span class="c1"># this code correctly translate the lat/lon limits into the projected coordinates</span>
    <span class="n">extents_proj</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">extents</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
    <span class="n">extents_proj</span> <span class="o">=</span> <span class="n">extents_proj</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gridlines</span> <span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dms</span><span class="o">=</span><span class="n">gridlines_dms</span><span class="p">,</span> <span class="n">x_inline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y_inline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">ylocs</span><span class="o">=</span><span class="p">[</span><span class="mi">46</span><span class="p">,</span><span class="mf">46.5</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mf">47.5</span><span class="p">])</span>

    <span class="c1"># TODO: Custom colormaps, interpolation, cropping</span>

    <span class="c1"># Upscale matrix for better reprojection</span>
    <span class="c1"># f = interp2d(lon, lat, map, kind=&#39;linear&#39;)</span>
    <span class="c1"># latnew = np.linspace(lat[0], lat[-1], (len(lat)-1)*3+1)</span>
    <span class="c1"># lonnew = np.linspace(lon[0], lon[-1], (len(lon)-1)*3+1)</span>
    <span class="c1"># mapnew = f(lonnew, latnew)</span>

    <span class="c1"># Upscale matrix for better reprojection</span>
    <span class="n">mapnew</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># show map with given cmap and set cmap limits</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mapnew</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="n">extents</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
        <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmap_limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">cmap_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cmap_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># colorbar</span>
    <span class="c1"># TODO: Add support for horizontal vertical option</span>
    <span class="k">if</span> <span class="n">cbar</span> <span class="p">:</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">cbar_label</span><span class="p">)</span>

    <span class="c1"># show schedule diagram</span>
    <span class="k">if</span> <span class="n">schedule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;25%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;25%&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">axes_class</span> <span class="o">=</span> <span class="n">get_projection_class</span><span class="p">(</span><span class="s1">&#39;polar&#39;</span><span class="p">),</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">schedule_bbox</span><span class="p">),</span>
            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">schedule_clock</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span><span class="n">schedule</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Exposure schedule&quot;</span><span class="p">)</span>

    <span class="c1"># TODO: Add more advanced title interpretation (i.e. smart date placeholder)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mch_logo</span> <span class="p">:</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_extent</span><span class="p">()</span>
        <span class="n">mch_logo_img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;python_tamer/mch_logo.png&#39;</span><span class="p">)</span>
        <span class="n">mch_logo_width</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="n">mch_logo_pad</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># some maths to work out position, note image aspect ratio 5:1</span>
        <span class="n">mch_extents</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">mch_logo_width</span><span class="o">-</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">mch_logo_pad</span><span class="p">,</span>
            <span class="n">ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">mch_logo_pad</span><span class="p">,</span>
            <span class="n">ex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">mch_logo_pad</span><span class="p">,</span>
            <span class="n">ex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mf">0.2</span><span class="o">*</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">mch_logo_width</span><span class="o">+</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">mch_logo_pad</span><span class="p">]</span>
        <span class="c1"># zorder puts image on top (behind mask otherwise for some reason)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mch_logo_img</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="n">mch_extents</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># TODO: Add plot title, small textbox description, copyright from dataset, ticks and gridlines</span>
    <span class="k">if</span> <span class="n">save</span> <span class="p">:</span>
        <span class="c1"># Generate timestamp filename if relying on default</span>
        <span class="k">if</span> <span class="n">img_filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="n">img_filename</span> <span class="o">=</span> <span class="n">format_filename</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">img_filename</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S_</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">img_filename</span> <span class="o">==</span> <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span>
            <span class="n">img_filename</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S_</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">img_dir</span><span class="o">+</span><span class="n">img_filename</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">img_filetype</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="n">img_dpi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span> <span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="schedule_clock"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.schedule_clock">[docs]</a><span class="k">def</span> <span class="nf">schedule_clock</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span><span class="n">schedule</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">title_size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">rmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generates a clock-style representation of an exposure schedule</span>

<span class="sd">    [extended_summary]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes : matplotlib.axes.Axes</span>
<span class="sd">        The polar axes upon which the clock will be plotted</span>
<span class="sd">    schedule : list or numpy.ndarray</span>
<span class="sd">        The exposure schedule - a length-24 vector of hourly exposure proportions</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Title of the exposure clock</span>
<span class="sd">    title_size : int, optional</span>
<span class="sd">        [description], by default 9</span>
<span class="sd">    center : float, optional</span>
<span class="sd">        [description], by default 0.25</span>
<span class="sd">    rmax : int, optional</span>
<span class="sd">        [description], by default 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [type]</span>
<span class="sd">        [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">/</span><span class="mi">24</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> 
        <span class="n">schedule</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">24</span><span class="p">,</span>
        <span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span>
        <span class="n">bottom</span><span class="o">=</span><span class="n">center</span><span class="p">)</span> 
    <span class="n">axes</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>      
    <span class="c1"># Set the circumference labels</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> 
    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="o">+</span><span class="n">center</span><span class="p">])</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;0.5&#39;</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="c1"># Make the labels go clockwise</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>       
    <span class="c1"># Place 0 at the top</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_theta_offset</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>   
    <span class="c1"># format grid and fake ticks</span>
    <span class="k">for</span> <span class="n">t</span>  <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">1.1</span><span class="p">])</span><span class="o">*</span><span class="n">rmax</span><span class="o">+</span><span class="n">center</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span>  <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">])</span><span class="o">*</span><span class="n">rmax</span><span class="o">+</span><span class="n">center</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>   
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">title_size</span><span class="p">)</span> 
    <span class="n">axes</span><span class="o">.</span><span class="n">set_rmax</span><span class="p">(</span><span class="n">rmax</span><span class="o">+</span><span class="n">center</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="gen_map_title"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.gen_map_title">[docs]</a><span class="k">def</span> <span class="nf">gen_map_title</span><span class="p">(</span>
<span class="n">statistic</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="n">exposure_schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">hour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">year_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">day_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">filename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SED&#39;</span><span class="p">,</span><span class="s1">&#39;J m-2&#39;</span><span class="p">,</span><span class="s1">&#39;UVIh&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">exposure_schedule</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;UV daily doses&#39;</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;UV doses&#39;</span>
    <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;W m-2&#39;</span><span class="p">,</span><span class="s1">&#39;UVI&#39;</span><span class="p">,</span><span class="s1">&#39;mW m-2&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exposure_schedule</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exposure_schedule</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1">#user chosen just one hour</span>
            <span class="n">hour</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">exposure_schedule</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;UV intensity between &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;h-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;h&#39;</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;UV intensity&#39;</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Units must be SED, J m-2, UVIh, UVI, W m-2, or mW m-2&#39;</span><span class="p">)</span>
    
    <span class="n">title</span> <span class="o">=</span> <span class="n">statistic</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span> <span class="n">title</span>

    <span class="n">ayear</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;2010-01-01&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;2010-12-31&quot;</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span> <span class="p">:</span> <span class="n">ayear</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;winter (DJF)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;spring (MAM)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;summer (JJA)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;autumn (SON)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;January&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;February&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;March&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;April&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;May&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;June&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;July&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;August&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;September&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;October&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;November&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;December&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ayear</span><span class="p">[</span><span class="n">ayear</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">day_str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">day_selection</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">:</span>
            <span class="n">day_str</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">break</span>

    
    <span class="k">if</span> <span class="n">day_str</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year_selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; for the year of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">year_selection</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; for the years &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">year_selection</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">year_selection</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; for the years: &#39;</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">year_selection</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">day_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; for &#39;</span> <span class="o">+</span> <span class="n">day_str</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year_selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">year_selection</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">year_selection</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">year_selection</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">year_selection</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

    <span class="k">else</span> <span class="p">:</span>
        <span class="c1"># TODO: potentially make this workable with &quot;custom day selection&quot; placeholder in title</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Day selection not recognised, auto-title cannot proceed&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="p">:</span>
        <span class="n">custom</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;UV.&quot;</span> <span class="o">+</span> <span class="n">units</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">statistic</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year_selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">year_selection</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">year_selection</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">year_selection</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;-custom&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
            <span class="n">custom</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">day_str_filenamer</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;January&quot;</span>   <span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;February&quot;</span>  <span class="p">:</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span>
            <span class="s2">&quot;March&quot;</span>     <span class="p">:</span> <span class="s2">&quot;03&quot;</span><span class="p">,</span>
            <span class="s2">&quot;April&quot;</span>     <span class="p">:</span> <span class="s2">&quot;04&quot;</span><span class="p">,</span>
            <span class="s2">&quot;May&quot;</span>       <span class="p">:</span> <span class="s2">&quot;05&quot;</span><span class="p">,</span>
            <span class="s2">&quot;June&quot;</span>      <span class="p">:</span> <span class="s2">&quot;06&quot;</span><span class="p">,</span>
            <span class="s2">&quot;July&quot;</span>      <span class="p">:</span> <span class="s2">&quot;07&quot;</span><span class="p">,</span>
            <span class="s2">&quot;August&quot;</span>    <span class="p">:</span> <span class="s2">&quot;08&quot;</span><span class="p">,</span>
            <span class="s2">&quot;September&quot;</span> <span class="p">:</span> <span class="s2">&quot;09&quot;</span><span class="p">,</span>
            <span class="s2">&quot;October&quot;</span>   <span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
            <span class="s2">&quot;November&quot;</span>  <span class="p">:</span> <span class="s2">&quot;11&quot;</span><span class="p">,</span>
            <span class="s2">&quot;December&quot;</span>  <span class="p">:</span> <span class="s2">&quot;12&quot;</span><span class="p">,</span>
            <span class="s2">&quot;winter (DJF)&quot;</span>  <span class="p">:</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spring (MAM)&quot;</span>  <span class="p">:</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;summer (JJA)&quot;</span>  <span class="p">:</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;autumn (SON)&quot;</span>  <span class="p">:</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;year&quot;</span>      <span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">}</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="n">day_str_filenamer</span><span class="p">[</span><span class="n">day_str</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">hour</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;h&#39;</span>
        <span class="k">if</span> <span class="n">custom</span> <span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.created_&#39;</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">format_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">title</span><span class="p">,</span> <span class="n">filename</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">title</span></div>
    





<div class="viewcode-block" id="calculate_map_from_hists"><a class="viewcode-back" href="../../code_reference.html#python_tamer.ExposureMap.calculate_map_from_hists">[docs]</a><span class="k">def</span> <span class="nf">calculate_map_from_hists</span><span class="p">(</span><span class="n">pix_hist</span><span class="p">,</span><span class="n">statistic</span><span class="p">,</span><span class="n">bin_centers</span><span class="p">)</span> <span class="p">:</span>

    <span class="c1"># Begin by defining the easy options that only require two inputs</span>
    <span class="n">basic_descriptor_functions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">hist_mean</span><span class="p">,</span>
        <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">hist_percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="s2">&quot;med&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">hist_percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="n">hist_stdev</span><span class="p">,</span>
        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">hist_stdev</span><span class="p">,</span>
        <span class="s2">&quot;stdev&quot;</span><span class="p">:</span> <span class="n">hist_stdev</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">hist_max</span><span class="p">,</span>
        <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="n">hist_max</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">hist_min</span><span class="p">,</span>
        <span class="s2">&quot;minimum&quot;</span><span class="p">:</span><span class="n">hist_min</span>
    <span class="p">}</span>
    <span class="c1"># we can check if the chosen statistic is basic or advanced</span>
    <span class="k">if</span> <span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">basic_descriptor_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
        <span class="c1"># in this case, we can simply select the basic function from the dict...</span>
        <span class="n">descriptor_function</span> <span class="o">=</span> <span class="n">basic_descriptor_functions</span><span class="p">[</span><span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="c1"># ...and execute it across the map</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">descriptor_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">bin_centers</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">pix_hist</span><span class="p">)</span>
    <span class="c1"># TODO: a loose space could ruin this, need shunting yard algorithm of sorts</span>
    <span class="k">elif</span> <span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;prct&quot;</span> <span class="ow">or</span> <span class="n">statistic</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;percentile&quot;</span> <span class="p">:</span>
        <span class="n">prct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">statistic</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hist_percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">bin_centers</span><span class="p">,</span><span class="n">prct</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">pix_hist</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="c1"># TODO: interpret self.statistic to build advanced functions (y i k e s)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Statistic string not recognised&quot;</span><span class="p">)</span>
    

    <span class="k">return</span> <span class="nb">map</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Todd C. Harris

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>